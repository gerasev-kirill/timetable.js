"use strict";var Timetable=function(){function e(e){var t=e<10?"0":"";return t+e+":00"}this.scope={hourStep:1,dateFormatter:function(t,n){return n?t.getDate()+"/"+t.getMonth()+", "+e(t.getHours()):e(t.getHours())}},this.locations=[],this.events=[]};Timetable.Renderer=function(e){if(!(e instanceof Timetable))throw new Error("Initialize renderer using a Timetable");this.timetable=e},function(){function e(e){return e===parseInt(e,10)}function t(e){return e=new Date(e),!isNaN(e.getTime())}function n(e){return!(!e||!(e.nodeName||e.prop&&e.attr&&e.find))}function i(e){return"function"==typeof e}function o(e,n){return t(e)&&t(n)}function a(e,t){return(t.getTime()-e.getTime())/1e3/60/60}function r(e,t){for(var n=0;n<t.length;n++)if(e===t[n].id)return!0;return!1}function s(e,n){var i=t(e)&&t(n),o=e<n;return i&&o}function l(e){var t=document.createElement("span");return t.innerHTML=e.trim(),t}function c(e,t,n){e.addEventListener("scroll",function(){"vertical"===n?t.style.top=e.scrollTop*-1+"px":t.style.left=e.scrollLeft*-1+"px"})}function d(){var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var i=n.offsetWidth;return e.parentNode.removeChild(e),t-i}function u(e){for(;e.firstChild;)e.removeChild(e.firstChild)}Timetable.prototype={setScope:function(e,t){if(!o(e,t))throw new RangeError("Timetable scope should consist of (start, end) in dates");return this.scope.start=new Date(e),this.scope.end=new Date(t),this},getScope:function(){return JSON.parse(JSON.stringify(this.scope))},setHourStep:function(t){if(!e(t)||t<0)throw new Error("Step should be int and more than 0");this.scope.hourStep=t},setDateFormatterFunction:function(e){this.scope.dateFormatter=e},addLocations:function(e){function t(){return e instanceof Array&&"string"==typeof e[0]}function n(){return e instanceof Array&&e[0]instanceof Object}var i=this.locations;if(t())e.forEach(function(e){if(r(e,i))throw new Error("Location already exists");i.push({id:e,title:e})});else{if(!n())throw new Error("Tried to add locations in wrong format");e.forEach(function(e){if(e.hasOwnProperty("locations")){if(r(e,i))throw new Error("Location already exists");return i.push(e),void e.locations.forEach(function(e){if(r(e,i))throw new Error("Location already exists");e instanceof Object?i.push(e):i.push({id:e,title:e})})}if(r(e,i))throw new Error("Location already exists");i.push(e)})}return this},addEvent:function(e,t,n,i,o){if(!r(t,this.locations))throw new Error("Unknown location");if(n=new Date(n),i=new Date(i),!s(n,i))return void console.log("Invalid time range: "+JSON.stringify([n,i]));var a="[object Object]"===Object.prototype.toString.call(o);return this.events.push({name:e,location:t,startDate:n,endDate:i,options:a?o:void 0}),this}},Timetable.Renderer.prototype={draw:function(t,o){function r(e){if(null===e)throw new Error("Timetable container not found")}function s(e){var t;if("vertical"===o){var n=document.createElement("div");n.className="aside-container",t=n.appendChild(document.createElement("aside")),e.appendChild(n)}else t=e.appendChild(document.createElement("aside"));var i=t.appendChild(document.createElement("ul"));p(i)}function p(e){for(var t=0;t<E.locations.length;t++){var n=E.locations[t].href,i=e.appendChild(document.createElement("li")),a=i.appendChild(document.createElement("span"));if("vertical"===o&&(i.className="th-column"),void 0!==n){var r=i.appendChild(document.createElement("a"));r.href=E.locations[t].href,r.appendChild(a)}a.className="row-heading",E.locations[t].hasOwnProperty("locations")&&(i.className="row-heading-section"),E.locations[t].hasOwnProperty("class")&&(i.className+=E.locations[t]["class"]),i.title=E.locations[t].title,a.textContent=E.locations[t].title}}function m(e){var t=e.appendChild(document.createElement("section")),n=t.appendChild(document.createElement("time")),i=h(n);return f(n,i)}function h(e){for(var t,n,i,o=e.appendChild(document.createElement("header")),a=o.appendChild(document.createElement("ul")),r=new Date(N);r.getTime()<=D.getTime();)t=a.appendChild(document.createElement("li")),n=l(E.scope.dateFormatter(r,r.getDate()!==i)),n.className="time-label",t.appendChild(n),i=r.getDate(),r.setHours(r.getHours()+E.scope.hourStep);return(o.getBoundingClientRect().height||0)-(t.getBoundingClientRect().height||0)}function f(e,t){"vertical"===o&&(e=e.appendChild(document.createElement("div")),e.className="room-timeline-vertical-container",e=e.appendChild(document.createElement("div")));var n=e.appendChild(document.createElement("ul"));n.className="room-timeline";for(var i=0;i<E.locations.length;i++){var a=n.appendChild(document.createElement("li"));if("vertical"===o&&t&&t>0&&(a.style.height=t+"px",a.className="td-column"),E.locations[i].hasOwnProperty("locations")){a.className=(a.className||"")+" section";var r=a.appendChild(document.createElement("b"));r.className="section-title";var s=r.appendChild(document.createElement("span"));s.textContent=E.locations[i].title}else v(E.locations[i],a)}return e}function v(e,t){for(var n=0;n<E.events.length;n++){var i=E.events[n];i.location===e.id&&y(i,t)}}function y(e,t){var n,a,r=void 0!==e.options,s=!1;r&&(n=void 0!==e.options.url,a=void 0!==e.options["class"],s=void 0!==e.options.data);var l=n?"a":"span",c=t.appendChild(document.createElement(l));if(r?(c.title=e.options.tooltip||e.name||"",i(e.options.onClick)&&c.addEventListener("click",function(){e.options.onClick(c,e)})):c.title=e.name||"",n&&(c.href=e.options.url),c.setAttribute("data-start-date",e.startDate),c.setAttribute("data-end-date",e.endDate),s)for(var d in e.options.data)c.setAttribute("data-"+d,e.options.data[d]);if(c.className=a?"time-entry "+e.options["class"]:"time-entry","vertical"===o){var u=g(e),p=w(e);p+u>100&&(u=100-p),p<0&&(u+=p,p=0),c.style.height=u+"%",c.style.top=p+"%"}else c.style.width=g(e)+"%",c.style.left=w(e)+"%";if(r&&e.options.template){var m=document.createElement("span");m.className="time-entry-template-content";var h=m.appendChild(document.createElement("span"));h.className="time-entry-template-content-inner",h.innerHTML=(e.options.template+"").trim(),c.appendChild(m)}else{var f=c.appendChild(document.createElement("small"));f.textContent=e.name}}function g(e){var t=a(e.startDate,e.endDate);return t/T*100}function w(e){var t=a(N,e.startDate);return t/T*100}var E=this.timetable,C=[];this.timetable.events.forEach(function(e){C.push(e.startDate),C.push(e.endDate)});var b=C.map(function(e){return e.getTime()}),N=this.timetable.scope.start,D=this.timetable.scope.end;if(["vertical","horizontal"].indexOf(o)===-1&&(o="horizontal"),!this.timetable.scope.start){var S=b.indexOf(Math.min.apply(null,b));N=C[S]}if(!this.timetable.scope.end){var x=b.indexOf(Math.max.apply(null,b));D=C[x]}0!==N.getMinutes()&&N.setMinutes(0);var T=a(N,D),O=T/E.scope.hourStep;e(O)||(T=Math.ceil(O)*E.scope.hourStep,D=new Date(N),D.setHours(T)),this.timetable.scope.durationHours=T;var H;if(H=n(t)?t:document.querySelector(t),r(H),u(H),s(H),m(H),"vertical"===o){var L=H.querySelector("aside > ul"),M=H.querySelector("section > time > header > ul"),R=H.querySelector(".room-timeline-vertical-container > div"),z=d()-1,j=function(){if(document.body.contains&&!document.body.contains(H))return void window.removeEventListener("resize",j);R.style.height=H.offsetHeight-L.offsetHeight+"px";var e=R.clientHeight<R.querySelector("ul.room-timeline").clientHeight;e?L.parentNode.style.paddingRight=z+"px":L.parentNode.style.paddingRight="0px"};c(R,L,"horizontal"),c(R,M,"vertical"),j(),window.addEventListener("resize",j)}}}}();
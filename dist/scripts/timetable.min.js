"use strict";var Timetable=function(){function e(e){var t=e<10?"0":"";return t+e+":00"}this.scope={hourStep:1,dateFormatter:function(t,n){return n?t.getDate()+"/"+t.getMonth()+", "+e(t.getHours()):e(t.getHours())}},this.locations=[],this.events=[]};Timetable.Renderer=function(e){if(!(e instanceof Timetable))throw new Error("Initialize renderer using a Timetable");this.timetable=e},function(){function e(e){return e===parseInt(e,10)}function t(e){return e=new Date(e),!isNaN(e.getTime())}function n(e){return!(!e||!(e.nodeName||e.prop&&e.attr&&e.find))}function i(e,n){return t(e)&&t(n)}function o(e,t){return(t.getTime()-e.getTime())/1e3/60/60}function a(e,t){for(var n=0;n<t.length;n++)if(e===t[n].id)return!0;return!1}function r(e,n){var i=t(e)&&t(n),o=e<n;return i&&o}function s(e){var t=document.createElement("span");return t.innerHTML=e.trim(),t}function l(e,t,n){e.addEventListener("scroll",function(i){"vertical"===n?t.style.top=e.scrollTop*-1+"px":t.style.left=e.scrollLeft*-1+"px"})}function c(){var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var i=n.offsetWidth;return e.parentNode.removeChild(e),t-i}function d(e){for(;e.firstChild;)e.removeChild(e.firstChild)}Timetable.prototype={setScope:function(e,t){if(!i(e,t))throw new RangeError("Timetable scope should consist of (start, end) in dates");return this.scope.start=new Date(e),this.scope.end=new Date(t),this},getScope:function(){return JSON.parse(JSON.stringify(this.scope))},setHourStep:function(t){if(!e(t)||t<0)throw new Error("Step should be int and more than 0");this.scope.hourStep=t},setDateFormatterFunction:function(e){this.scope.dateFormatter=e},addLocations:function(e){function t(){return e instanceof Array&&"string"==typeof e[0]}function n(){return e instanceof Array&&e[0]instanceof Object}var i=this.locations;if(t())e.forEach(function(e){if(a(e,i))throw new Error("Location already exists");i.push({id:e,title:e})});else{if(!n())throw new Error("Tried to add locations in wrong format");e.forEach(function(e){if(e.hasOwnProperty("locations")){if(a(e,i))throw new Error("Location already exists");return i.push(e),void e.locations.forEach(function(e){if(a(e,i))throw new Error("Location already exists");e instanceof Object?i.push(e):i.push({id:e,title:e})})}if(a(e,i))throw new Error("Location already exists");i.push(e)})}return this},addEvent:function(e,t,n,i,o){if(!a(t,this.locations))throw new Error("Unknown location");if(n=new Date(n),i=new Date(i),!r(n,i))return void console.log("Invalid time range: "+JSON.stringify([n,i]));var s="[object Object]"===Object.prototype.toString.call(o);return this.events.push({name:e,location:t,startDate:n,endDate:i,options:s?o:void 0}),this}},Timetable.Renderer.prototype={draw:function(t,i){function a(e){if(null===e)throw new Error("Timetable container not found")}function r(e){if("vertical"===i){var t=document.createElement("div");t.className="aside-container";var n=t.appendChild(document.createElement("aside"));e.appendChild(t)}else var n=e.appendChild(document.createElement("aside"));var o=n.appendChild(document.createElement("ul"));u(o)}function u(e){for(var t=0;t<w.locations.length;t++){var n=w.locations[t].href,o=e.appendChild(document.createElement("li")),a=o.appendChild(document.createElement("span"));if("vertical"===i&&(o.className="th-column"),void 0!==n){var r=o.appendChild(document.createElement("a"));r.href=w.locations[t].href,r.appendChild(a)}a.className="row-heading",w.locations[t].hasOwnProperty("locations")&&(o.className="row-heading-section"),w.locations[t].hasOwnProperty("class")&&(o.className+=w.locations[t]["class"]),o.title=w.locations[t].title,a.textContent=w.locations[t].title}}function p(e){var t=e.appendChild(document.createElement("section")),n=t.appendChild(document.createElement("time")),i=m(n);return h(n,i)}function m(e){for(var t,n,i,o=e.appendChild(document.createElement("header")),a=o.appendChild(document.createElement("ul")),r=new Date(b);r.getTime()<=N.getTime();)t=a.appendChild(document.createElement("li")),n=s(w.scope.dateFormatter(r,r.getDate()!==i)),n.className="time-label",t.appendChild(n),i=r.getDate(),r.setHours(r.getHours()+w.scope.hourStep);return(o.getBoundingClientRect().height||0)-(t.getBoundingClientRect().height||0)}function h(e,t){"vertical"===i&&(e=e.appendChild(document.createElement("div")),e.className="room-timeline-vertical-container",e=e.appendChild(document.createElement("div")));var n=e.appendChild(document.createElement("ul"));n.className="room-timeline";for(var o=0;o<w.locations.length;o++){var a=n.appendChild(document.createElement("li"));if("vertical"===i&&t&&t>0&&(a.style.height=t+"px",a.className="td-column"),w.locations[o].hasOwnProperty("locations")){a.className=(a.className||"")+" section";var r=a.appendChild(document.createElement("b"));r.className="section-title";var s=r.appendChild(document.createElement("span"));s.textContent=w.locations[o].title}else f(w.locations[o],a)}return e}function f(e,t){for(var n=0;n<w.events.length;n++){var i=w.events[n];i.location===e.id&&v(i,t)}}function v(e,t){var n,o,a=void 0!==e.options,r=!1;a&&(n=void 0!==e.options.url,o=void 0!==e.options["class"],r=void 0!==e.options.data);var s=n?"a":"span",l=t.appendChild(document.createElement(s));if(a?l.title=e.options.tooltip||e.name||"":l.title=e.name||"",n&&(l.href=e.options.url),l.setAttribute("data-start-date",e.startDate),l.setAttribute("data-end-date",e.endDate),r)for(var c in e.options.data)l.setAttribute("data-"+c,e.options.data[c]);if(l.className=o?"time-entry "+e.options["class"]:"time-entry","vertical"===i){var d=g(e),u=y(e);u+d>100&&(d=100-u),u<0&&(d+=u,u=0),l.style.height=d+"%",l.style.top=u+"%"}else l.style.width=g(e)+"%",l.style.left=y(e)+"%";if(a&&e.options.template){var p=document.createElement("span");p.className="time-entry-template-content";var m=p.appendChild(document.createElement("span"));m.className="time-entry-template-content-inner",m.innerHTML=(e.options.template+"").trim(),l.appendChild(p)}else{var h=l.appendChild(document.createElement("small"));h.textContent=e.name}}function g(e){var t=o(e.startDate,e.endDate);return t/x*100}function y(e){var t=o(b,e.startDate);return t/x*100}var w=this.timetable,E=[];this.timetable.events.forEach(function(e){E.push(e.startDate),E.push(e.endDate)});var C=E.map(function(e){return e.getTime()}),b=this.timetable.scope.start,N=this.timetable.scope.end;if(["vertical","horizontal"].indexOf(i)===-1&&(i="horizontal"),!this.timetable.scope.start){var D=C.indexOf(Math.min.apply(null,C));b=E[D]}if(!this.timetable.scope.end){var S=C.indexOf(Math.max.apply(null,C));N=E[S]}0!==b.getMinutes()&&b.setMinutes(0);var x=o(b,N),T=x/w.scope.hourStep;e(T)||(x=Math.ceil(T)*w.scope.hourStep,N=new Date(b),N.setHours(x)),this.timetable.scope.durationHours=x;var O;if(O=n(t)?t:document.querySelector(t),a(O),d(O),r(O),p(O),"vertical"===i){var H=O.querySelector("aside > ul"),L=O.querySelector("section > time > header > ul"),M=O.querySelector(".room-timeline-vertical-container > div"),R=c()-1,z=function(){if(document.body.contains&&!document.body.contains(O))return void window.removeEventListener("resize",z);M.style.height=O.offsetHeight-H.offsetHeight+"px";var e=M.clientHeight<M.querySelector("ul.room-timeline").clientHeight;e?(console.log(H.parentNode),H.parentNode.style.paddingRight=R+"px"):H.parentNode.style.paddingRight="0px",console.log(e,R)};l(M,H,"horizontal"),l(M,L,"vertical"),z(),window.addEventListener("resize",z)}}}}();